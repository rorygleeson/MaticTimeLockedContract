<!DOCTYPE html>
<html lang="en">

<head>
      <meta charset="UTF-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css">
      <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/3.0.0-rc.5/web3.min.js"></script>
      <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
      <script src="https://unpkg.com/gijgo@1.9.13/js/gijgo.min.js" type="text/javascript"></script>
      <link href="https://unpkg.com/gijgo@1.9.13/css/gijgo.min.css" rel="stylesheet" type="text/css" />



      <title>Time Locked Wallet</title>
</head>
   
   
<body>
   
<style>
    /* Used for Metamask icon*/
    .meta-gray {
    -webkit-filter: grayscale(1);
    }
    .meta-normal {
    -webkit-filter: grayscale(0);
    }
    /* Rounded border */
    hr.rounded {
    border-top: 8px solid #bbb;
    border-radius: 5px;
    }
    /* Solid border */
    hr.solid {
    border-top: 3px solid #bbb;
    }
</style>
	  
	  
<div class="container">
		
		<div style="margin-top: 30px;background-color:#F6F6F6;" class="row text-center">
			<div class="col-md-12">
			
				<hr class="rounded">
				<br>
				<h3>Time Locked Wallet DAPP</h3>
				<br>
				<hr class="rounded">
				<br>
			</div>
		</div>
		 
		 
		<br><br>
		 
		 
		<div class="row text-center">
			<div class="col-md-12">
				<img id="metaicon" class="meta-gray" width="100" height="100" src="metamask-icon.png" alt="">
			</div>
		</div>
			
			
		<div style="margin-top: 30px;" class="row text-center">
			<div class="col-md-12">
				<button id="enableMetamask" class="btn btn-primary">Connect with Metamask</button>
			</div>
		</div>
			
			
			
		<br><br>
			
		<div class="row text-center">
			<div class="col-md-12">
				<span id="status"></span>
			</div>
		</div>
		<br><br>
			
			
		<hr class="rounded">
		<br><br>

	    <section class="contract-section hidden">
			
            
            <div style="margin-top: 30px;" class="row text-center">
				<div class="col-md-12">
					<h5>Time Locked Wallet Contract Details</h5>
					</br>
					<h6>Matic (test mumbai) </h6>
					<br>
                    <h6><a href="https://mumbai.polygonscan.com/address/0xd1e91F77bF39C99e3Ce04Bd43Fe5FdB524Db4043">Time Locked Wallet  Contract ID : 0xd1e91F77bF39C99e3Ce04Bd43Fe5FdB524Db4043 </a></h6>
				</div>
			</div>

			<br><br>
			<hr class="solid">
			<br><br>


            <div class="row text-center">
               	<div class="col-md-12">
                  	<h4>Get Wallets</h4>

                      <p>Get Time Locked Wallet(s) associated with any address</p>
                  		<span>
						<div class="col-md-8  offset-2"> 
							<input id="getWallets_value" type="text" class="form-control" value="">  <br>
							<button id="getWallets" class="btn btn-primary"> Get Wallets</button>  
                        </div> 
						</span>
						
				</div>
			</div>

			<br>
			
			<div class="row text-center" id="showGetWalletsResult">
				<div class="col-md-12">
					<h4>Result </h4>
                    <span>
                        <div class="col-md-8  offset-2">
                            <p>Time Locked Wallet(s) owned </p>
                            <textarea class="form-control" id="getWalletsResult" style="font-size:12px;text-align:center" rows="3"></textarea>
                        </div>


                    </span>                   
				</div>
			</div>
			
    
            <br><br>
			<hr class="solid">
			<br><br>



            <div class="row text-center">
                <div class="col-md-12">
                   <h4>Get Details for any Time Locked Wallet</h4>

                   <p>Enter Time Locked Wallet address</p>
                       <span>
                     <div class="col-md-8  offset-2"> 
                         <input id="getTimeLockedWallets_value" type="text" class="form-control" value="">  <br>
                         <button id="getTimeLockedWallets" class="btn btn-primary"> Get Wallets</button>  
                     </div> 
                     </span>
                     
             </div>
         </div>

         <br>
       
		   


        <div class="row text-center" id="showGetTimeLockedWalletsResult">
            <div class="col-md-12">
                <h4>Time Locked Wallet Details</h4>     
                <span>
                    <table class="table">
                        <tbody>
                          <tr>
                            <td> Owner </td>
                            <td> <i id="Owner"></i></td>
                          </tr>

                          <tr>
                            <td> Creator </td>
                            <td> <i id="Creator"></i></td>
                          </tr>

                          <tr>
                            <td> Unlock Date </td>
                            <td> <i id="UnlockDate"></i></td>
                          </tr>

                          <tr>
                            <td> Created Date </td>
                            <td> <i id="CreatedDate"></i></td>
                          </tr>

                          <tr>
                            <td> Balance </td>
                            <td> <i id="Balance"></i></td>
                          </tr>
                        </tbody>
                      </table>
                </span>                   
            </div>
        </div>



        <br><br>
        <hr class="solid">
        <br><br>


            
			<div class="row text-center">
				<div class="col-md-12">
					<h4>Create a time locked wallet</h4>
						<p>enter the wallet address of the owner</p>
						<span>
							<div class="col-md-8  offset-2"> 
								<input id="createWallet_value" type="text" class="form-control" value="">     <br><br>

                                <p>enter the unlock date</p>
                                <input id="input"/><br>

								<p>enter the amount </p>
                                <input id="amount"/> <br><br>


								<button id="createWallet" class="btn btn-primary"> Create Time Locked Wallet </button>   
						    </div>
                        </span>
				</div>
			</div>
			<br>
			
        


            <div class="row text-center"  id="showCreateWalletResult">
                <div class="col-md-12">
                   <h4> Contract ID of Time Locked Wallet Created  </h4>
                    <span>
                     <div class="col-md-12"> 
                         <input id="createWalletResult" type="text" class="form-control" value="">   
                     </div> 
                    </span>
                     
                </div>
            </div>







            

			<br><br>
			<hr class="solid">
			<br><br>


          





		</section>

        
</div>
		
		
		
		
		
		
		
		
		
		
<script>
         let currentAccount = null;
         let web3;
         let Token_contractAddress = '0xd1e91F77bF39C99e3Ce04Bd43Fe5FdB524Db4043'
         let haveMetaMaskAccount = false;
         
         
         document.getElementById('showGetWalletsResult').setAttribute("style", "display:none");
		 
         document.getElementById('showCreateWalletResult').setAttribute("style", "display:none"); 

         document.getElementById('showGetTimeLockedWalletsResult').setAttribute("style", "display:none"); 


		  
		 console.log('Hello, start');
		 		

		 
         // Set up a timer and check when variable haveMetaMaskAccount is set to true, meaning a user is logged in and the app knows the users account address
         (async() => {
         while(!haveMetaMaskAccount) 
         await new Promise(resolve => setTimeout(resolve, 1000));
         	console.log('Have Metamask Account Good');
         })();     
</script>
	  
	  
<script>   
        $( document ).ready(function() 
        {
         
            m = detectMetaMask()
            if(m) {
                $('#metaicon').removeClass('meta-gray')
                $('#metaicon').addClass('meta-normal')
                $('#enableMetamask').attr('disabled',false)
                connect() // Make sure the connected wallet is being returned
            } else {
                $('#enableMetamask').attr('disabled',true)
                $('#metaicon').removeClass('meta-normal')
                $('#metaicon').addClass('meta-gray')
            }
         
            $('#enableMetamask').click(function() {
                 connect()
            });
         
           
          
			$('#getWallets').click(function() {
                 getWallets()
             });


             $('#getTimeLockedWallets').click(function() {
                 getTimeLockedWallets()
             });
         
             $('#createWallet').click(function() {
                createWallet()
             });


             try 
				{   
					web3 = new Web3(window.ethereum)
				} 	catch (error) 
				{
					alert(error)
				}            
        })
</script>  
	
	
	
<script> 
    // Functions and abi definition here
         
    var abi = [
	{
		"constant": false,
		"inputs": [
			{
				"name": "_owner",
				"type": "address"
			},
			{
				"name": "_unlockDate",
				"type": "uint256"
			}
		],
		"name": "newTimeLockedWallet",
		"outputs": [
			{
				"name": "wallet",
				"type": "address"
			}
		],
		"payable": true,
		"stateMutability": "payable",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [
			{
				"name": "_user",
				"type": "address"
			}
		],
		"name": "getWallets",
		"outputs": [
			{
				"name": "",
				"type": "address[]"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "fallback"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"name": "wallet",
				"type": "address"
			},
			{
				"indexed": false,
				"name": "from",
				"type": "address"
			},
			{
				"indexed": false,
				"name": "to",
				"type": "address"
			},
			{
				"indexed": false,
				"name": "createdAt",
				"type": "uint256"
			},
			{
				"indexed": false,
				"name": "unlockDate",
				"type": "uint256"
			},
			{
				"indexed": false,
				"name": "amount",
				"type": "uint256"
			}
		],
		"name": "Created",
		"type": "event"
	}
]
          
 







var abi2= [
	{
		"constant": false,
		"inputs": [],
		"name": "withdraw",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"constant": false,
		"inputs": [
			{
				"name": "_tokenContract",
				"type": "address"
			}
		],
		"name": "withdrawTokens",
		"outputs": [],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"name": "_creator",
				"type": "address"
			},
			{
				"name": "_owner",
				"type": "address"
			},
			{
				"name": "_unlockDate",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"payable": true,
		"stateMutability": "payable",
		"type": "fallback"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"name": "from",
				"type": "address"
			},
			{
				"indexed": false,
				"name": "amount",
				"type": "uint256"
			}
		],
		"name": "Received",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"name": "to",
				"type": "address"
			},
			{
				"indexed": false,
				"name": "amount",
				"type": "uint256"
			}
		],
		"name": "Withdrew",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"name": "tokenContract",
				"type": "address"
			},
			{
				"indexed": false,
				"name": "to",
				"type": "address"
			},
			{
				"indexed": false,
				"name": "amount",
				"type": "uint256"
			}
		],
		"name": "WithdrewTokens",
		"type": "event"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "createdAt",
		"outputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "creator",
		"outputs": [
			{
				"name": "",
				"type": "address"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "info",
		"outputs": [
			{
				"name": "",
				"type": "address"
			},
			{
				"name": "",
				"type": "address"
			},
			{
				"name": "",
				"type": "uint256"
			},
			{
				"name": "",
				"type": "uint256"
			},
			{
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "owner",
		"outputs": [
			{
				"name": "",
				"type": "address"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	},
	{
		"constant": true,
		"inputs": [],
		"name": "unlockDate",
		"outputs": [
			{
				"name": "",
				"type": "uint256"
			}
		],
		"payable": false,
		"stateMutability": "view",
		"type": "function"
	}
]      
 








      
         
         
function handleAccountsChanged(accounts) 
{ 
    if (accounts.length === 0) 
    {
        $('#enableMetamask').html('Connect now with Metamask')
    } 
    else if (accounts[0] !== currentAccount) 
    {
        currentAccount = accounts[0];
        $('#enableMetamask').html(currentAccount)
        $('#status').html('Metamask CONNECTED')
         
        if(currentAccount != null) 
        {
            // Set the button label
        $('#enableMetamask').html(currentAccount)
        haveMetaMaskAccount=true;
        }
    }
    console.log('WalletAddress in HandleAccountChanged ='+currentAccount)
}
         
         
function connect() 
{
    ethereum
    .request({ method: 'eth_requestAccounts' })
    .then(handleAccountsChanged)
    .catch((err) => {
    if (err.code === 4001) {
    // EIP-1193 userRejectedRequest error
    // If this happens, the user rejected the connection request.
    console.log('Please connect to MetaMask.');
    $('#status').html('You refused to connect Metamask')
    } else {
    console.error(err);
    }
    });
}
         
         
         
         
         
function detectMetaMask() 
{
    if (typeof window.ethereum !== 'undefined') 
    {    
        return true
    } else 
    { 
        return false
    }
}
         
         
         	
         	
async function getWallets() 
{	
    try {
    document.getElementById('showGetWalletsResult').setAttribute("style", "display:none");	
    input_value = $('#getWallets_value').val()
         			
    const contractFirst = new web3.eth.Contract
    (
        abi,
        Token_contractAddress
    );
         			
    contractFirst.methods.getWallets(input_value).call((err, result) => 
    {  

        console.log('Get Wallets Result');       
        console.log(result);        
		let length =  result.length;
		console.log("Lenght of Array");     
		console.log(length);  

      			

        let text = result.toString();
        text1 = text.replace(/,/g, '\n');               
        document.getElementById("getWalletsResult").value = text1;
             
      
    }
    )

    }catch (error) {

        document.getElementById("getWalletsResult").value = "There are no Time Locked Wallets owned by this address";

  }

  document.getElementById('showGetWalletsResult').setAttribute("style", "display:block");


}
         
         
async function createWallet() 
{		
		document.getElementById('showCreateWalletResult').setAttribute("style", "display:none");	
        input_value = $('#createWallet_value').val()
        input_value2 = $('#input').val()
        input_value3 = $('#amount').val()
        
			
        console.log('In Create Wallets');   
        console.log('Input Val 1 is'); 
        console.log(input_value); 
        console.log('Input Val 2 is');   
        console.log(input_value2); 
		console.log('Input Val 3 is');   
        console.log(input_value3); 

        const owner = input_value;
        const amount = input_value3;

        const datetimeArray = input_value2.split(' ');
        const timepart = datetimeArray[0];
        const datepart = datetimeArray[1];

        console.log('timepart is');
        console.log(timepart);
        console.log('datepart is');
        console.log(datepart);
        const dateArray = datepart.split('/');

        const year = dateArray[2];
        const day = dateArray[1];
        const month = dateArray[0];

        console.log('date is');
        console.log(year);
        console.log(day);
        console.log(month);

        var finalDateTimeString = year;
        finalDateTimeString = finalDateTimeString.concat("-");
        finalDateTimeString = finalDateTimeString.concat(month);
        finalDateTimeString = finalDateTimeString.concat("-");
        finalDateTimeString = finalDateTimeString.concat(day);
        finalDateTimeString = finalDateTimeString.concat('T');
        finalDateTimeString = finalDateTimeString.concat(timepart);

        console.log("finalDateTimeString");

        console.log(finalDateTimeString);


		//const moonLanding = new Date('2022-03-25T12:00:00Z');
        const dateAndTimeForConversion = new Date(finalDateTimeString);

        // milliseconds since Jan 1, 1970, 00:00:00.000 GMT

		unixSeconds = dateAndTimeForConversion.getTime();
        unixSeconds = unixSeconds/1000;
        console.log('unixSeconds');
	    console.log(unixSeconds);

        const unlockDate = unixSeconds;

        console.log('Final Vals before function call, owner and unlock date');
        console.log(owner);
        console.log(unlockDate);




       // console.log(dateAndTimeForConversion.getTime());
	   

       // let finalString = input_value.concat(input_value2);
       // console.log('finalString'); 
       // console.log(finalString); 

       // console.log(finalString.getTime());
        


        const contractFirst = new web3.eth.Contract(
                abi,
                Token_contractAddress
        );
         		
         			
         			 
        const expectedBlockTime = 5000; 
        //const receiverAddress = input_value
         			
         			
        const sleep = (milliseconds) => {
         	return new Promise(resolve => setTimeout(resolve, milliseconds))
        }
         			
        (async function () 
            {
         			
                    console.log('Run Create Wallets');      
					contractFirst.methods.newTimeLockedWallet(owner, unlockDate).send({from: currentAccount}, async function(error, transactonHash) {
         			console.log("Submitted transaction with hash: ", transactonHash)
         			let transactionReceipt = null
         			while (transactionReceipt == null) { // Waiting expectedBlockTime until the transaction is mined
         					transactionReceipt = await web3.eth.getTransactionReceipt(transactonHash)
         					await sleep(expectedBlockTime)
         			}
         				
         			
                    console.log("Got the transaction receipt: ", transactionReceipt)	
                    
                    mylogs = transactionReceipt.logs
                    walletCreated = transactionReceipt.logs[0].address
                    console.log("MY LOGS ", mylogs)
                    console.log("Wallet Created =  ", walletCreated)
						
					
                    document.getElementById("createWalletResult").value = walletCreated
		            document.getElementById('showCreateWalletResult').setAttribute("style", "display:block")	
						
         				
         			
         				
         			});
          
         	})();
         			
         
            
           




}








    	
         	
async function getTimeLockedWallets() 
{	

    console.log('In time locked wallet function'); 
    try {
    document.getElementById('showGetTimeLockedWalletsResult').setAttribute("style", "display:none");	

    input_value = $('#getTimeLockedWallets_value').val()
    
    console.log("input_value is"); 
    console.log(input_value); 

    let Token_contractAddress2 = input_value

    

    const contractFirst2 = new web3.eth.Contract
    (
        abi2,
        Token_contractAddress2
    );
        
    console.log("Wallet Contract Address is"); 
    console.log(Token_contractAddress2); 

    console.log('Print Contract'); 
    console.log(contractFirst2); 



    console.log('CURRENT ACCOUNT'); 
    console.log(currentAccount);



    console.log('Run It'); 


    contractFirst2.methods.info().call((err, result) => 
    {  

        console.log('info is'); 
        console.log(result);   
        
        
        console.log('individual fields'); 
        console.log('creator'); 
        console.log(result[0]); 

        console.log('owner'); 
        console.log(result[1]); 

        console.log('unlockDate'); 
        console.log(result[2]); 

        console.log('creastedAt'); 
        console.log(result[3]);  

        console.log('balance'); 
        console.log(result[4]); 



    console.log('TIME CONVERSIONS Unlock Date'); 


    let dateOfUnlockUnixSecs =    result[2]*1000;  
    dateOfUnlock =  new Date(dateOfUnlockUnixSecs);
 
    var unlockDateMonth = dateOfUnlock.toLocaleDateString("default", {month:"short"}); 
    var unlockDateYear = dateOfUnlock.toLocaleDateString("default", {year:"numeric"}); 
    var unlockDateDay = dateOfUnlock.toLocaleDateString("default", {day:"numeric"}); 
    var unlockTime = dateOfUnlock.toLocaleTimeString("default");  


    
    
    console.log(unlockDateMonth); 
    console.log(unlockDateYear); 
    console.log(unlockDateDay); 
    console.log(unlockTime); 



  var finalUnlockDateTime = unlockDateMonth;
  finalUnlockDateTime =  finalUnlockDateTime.concat(" ");
  finalUnlockDateTime =  finalUnlockDateTime.concat(unlockDateDay);
  finalUnlockDateTime =  finalUnlockDateTime.concat(" ");
  finalUnlockDateTime =  finalUnlockDateTime.concat(unlockDateYear);
  finalUnlockDateTime =  finalUnlockDateTime.concat("   ");
  finalUnlockDateTime =  finalUnlockDateTime.concat(unlockTime);



  console.log('Converted FINAL UNLOCK');
  console.log(finalUnlockDateTime);






  console.log('TIME CONVERSIONS Creationg Date'); 


    let dateOfCreationUnixSecs =    result[3]*1000;  
    dateOfCreation=  new Date(dateOfCreationUnixSecs);
    
    

    var creationDateMonth = dateOfCreation.toLocaleDateString("default", {month:"short"}); 
    var creationDateYear = dateOfCreation.toLocaleDateString("default", {year:"numeric"}); 
    var creationDateDay = dateOfCreation.toLocaleDateString("default", {day:"numeric"}); 
    var creationTime = dateOfCreation.toLocaleTimeString("default");  



    console.log(creationTime); 
    console.log(creationDateMonth); 
    console.log(creationDateYear); 
    console.log(creationDateDay); 




  var finalCreationDateTime = creationDateMonth;
  finalCreationDateTime =  finalCreationDateTime.concat(" ");
  finalCreationDateTime =  finalCreationDateTime.concat(creationDateDay);
  finalCreationDateTime =  finalCreationDateTime.concat(" ");
  finalCreationDateTime =  finalCreationDateTime.concat(creationDateYear);
  finalCreationDateTime =  finalCreationDateTime.concat("    ");
  finalCreationDateTime =  finalCreationDateTime.concat(creationTime);




  console.log('Converted FINAL CREATION DATE');
  console.log(finalCreationDateTime);






        $('#Owner').html(result[0]);
        $('#Creator').html(result[1]);
        $('#UnlockDate').html(finalUnlockDateTime);
        $('#CreatedDate').html(finalCreationDateTime);
        $('#Balance').html(result[4]);

  
    }
    )

    }catch (error) {
        console.log('Catch Error here'); 
        document.getElementById("getTimeLockedWalletsResult").value = "There are no Time Locked Wallets owned by this address";

  }

  document.getElementById('showGetTimeLockedWalletsResult').setAttribute("style", "display:block");
 // document.getElementById('getTimeLockedWalletsResult').setAttribute("style", "display:block");
 // document.getElementById('getTimeLockedWalletsResultOwner').setAttribute("style", "display:block");
 // document.getElementById('getTimeLockedWalletsResultUnlockDate').setAttribute("style", "display:block");
 // document.getElementById('getTimeLockedWalletsResultCreatedAt').setAttribute("style", "display:block");
 // document.getElementById('getTimeLockedWalletsResultBalance').setAttribute("style", "display:block");
}
         
         		          
         			
</script>

<script>
    $('#input').datetimepicker({
        uiLibrary: 'bootstrap4',
        modal: true,
        footer: true
    });
</script>


</body>
</html>
